@* 
  Admin / Randevu Listesi
  Model: PagedResult<AppointmentDto>
  Filtreler: tarih aralığı, durum, onay durumu, arama
*@
@model Dyt.Contracts.Common.PagedResult<Dyt.Contracts.Appointments.Responses.AppointmentDto>

@{
    // Görüntü başlığını ayarlıyorum
    ViewData["Title"] = "Randevu Listesi";
    // Filtreleri ViewBag üzerinden geri alıyorum (Controller'da ViewBag.Filters = request yapılmıştı)
    var f = (Dyt.Contracts.Appointments.Requests.AppointmentQueryRequest)ViewBag.Filters;
    var rejectInfo = TempData["RejectInfo"] as string;
}

<div class="container" style="max-width:1100px;margin:32px auto;">
    <h1 style="font-size:22px;margin-bottom:16px;">Randevu Listesi</h1>

    <!-- Filtre formu -->
    <form method="get" style="display:grid;grid-template-columns:repeat(6,1fr);gap:12px;align-items:end;border:1px solid #e5e7eb;padding:12px;border-radius:12px;background:#fff;">
        <div>
            <label style="display:block;font-size:12px;color:#6b7280;">Başlangıç</label>
            <input type="date" name="from" value="@(f.DateFrom?.ToString("yyyy-MM-dd"))" class="form-control" placeholder="gg.aa.yyyy" />
        </div>
        <div>
            <label style="display:block;font-size:12px;color:#6b7280;">Bitiş</label>
            <input type="date" name="to" value="@(f.DateTo?.ToString("yyyy-MM-dd"))" class="form-control" placeholder="gg.aa.yyyy" />
        </div>
        <div>
            <label style="display:block;font-size:12px;color:#6b7280;">Durum</label>
            <select name="status" class="form-select">
                <option value="">Hepsi</option>
                @foreach (var s in new[] { "Scheduled", "Canceled", "NoShow" })
                {
                    var sel = f.Status == s ? "selected" : null;
                    <option value="@s" selected="@sel">@("Scheduled"==s?"Planlandı":("Canceled"==s?"İptal":"Gelmedi"))</option>
                }
            </select>
        </div>
        <div>
            <label style="display:block;font-size:12px;color:#6b7280;">Onay</label>
            <select name="confirmation" class="form-select">
                <option value="">Hepsi</option>
                @foreach (var s in new[] { "Yanıtlanmadı", "Gelecek", "Gelmeyecek" })
                {
                    var sel2 = f.ConfirmationState == s ? "selected" : null;
                    <option value="@s" selected="@sel2">@s</option>
                }
            </select>
        </div>
        <div>
            <label style="display:block;font-size:12px;color:#6b7280;">Arama</label>
            <input type="text" name="search" value="@(f.Search)" placeholder="Ad/Telefon" class="form-control" />
        </div>
        <div>
            <label style="display:block;font-size:12px;color:#6b7280;">&nbsp;</label>
            <button type="submit" class="btn btn-primary">Filtrele</button>
        </div>
    </form>

    <!-- Liste tablosu -->
    <div style="margin-top:16px;overflow:auto;border:1px solid #e5e7eb;border-radius:12px;background:#fff;">
        <table class="table" style="margin:0;">
            <thead>
                <tr>
                    <th>Tarih</th>
                    <th>Saat</th>
                    <th>Danışan</th>
                    <th>Telefon</th>
                    <th>Durum</th>
                    <th>Onay</th>
                    <th style="width:260px;">İşlemler</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.Items.Count == 0)
                {
                    <tr><td colspan="7" class="text-center">Kayıt bulunamadı.</td></tr>
                }
                else
                {
                    foreach (var a in Model.Items)
                    {
                        var isPending = string.Equals(a.ConfirmationState, "Yanıtlanmadı", StringComparison.OrdinalIgnoreCase);
                        var isAccepted = string.Equals(a.ConfirmationState, "Gelecek", StringComparison.OrdinalIgnoreCase);
                        var isDeclined = string.Equals(a.ConfirmationState, "Gelmeyecek", StringComparison.OrdinalIgnoreCase);
                        <tr>
                            <td>@a.Date.ToString("yyyy-MM-dd")</td>
                            <td>@a.StartTime.ToString("HH\\:mm") - @a.EndTime.ToString("HH\\:mm")</td>
                            <td>@a.ClientName</td>
                            <td>@a.ClientPhone</td>
                            <td>@a.Status</td>
                            <td>@a.ConfirmationState</td>
                            <td class="d-flex gap-2">
                                @if (isPending)
                                {
                                    <form asp-area="Admin" asp-controller="Appointments" asp-action="SetConfirmation" method="post">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="id" value="@a.Id" />
                                        <input type="hidden" name="state" value="Gelecek" />
                                        <button class="btn btn-sm btn-success">Onayla</button>
                                    </form>
                                    <form asp-area="Admin" asp-controller="Appointments" asp-action="SetConfirmation" method="post" onsubmit="return confirmDecline('@a.ClientName');">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="id" value="@a.Id" />
                                        <input type="hidden" name="state" value="Gelmeyecek" />
                                        <button class="btn btn-sm btn-outline-danger">Reddet</button>
                                    </form>
                                }
                                else if (isAccepted)
                                {
                                    <form asp-area="Admin" asp-controller="Appointments" asp-action="SetConfirmation" method="post">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="id" value="@a.Id" />
                                        <input type="hidden" name="state" value="Gelmeyecek" />
                                        <button class="btn btn-sm btn-outline-danger">Tercihi Değiştir (Reddet)</button>
                                    </form>
                                }
                                else if (isDeclined)
                                {
                                    <form asp-area="Admin" asp-controller="Appointments" asp-action="SetConfirmation" method="post">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="id" value="@a.Id" />
                                        <input type="hidden" name="state" value="Gelecek" />
                                        <button class="btn btn-sm btn-success">Tercihi Değiştir (Onayla)</button>
                                    </form>
                                }
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    <!-- Sayfalama -->
    @{
        var totalPages = (int)Math.Ceiling(Model.TotalCount / (double)Model.PageSize); // Toplam sayfa sayısını hesaplıyorum
        var current = Model.Page; // Mevcut sayfayı alıyorum
    }
    <nav aria-label="Sayfalama" style="margin-top:12px;">
        <ul class="pagination">
            <li class="page-item @(current <= 1 ? "disabled" : null)">
                <a class="page-link" href="@Url.Action("Index", new { page = current - 1, pageSize = Model.PageSize, from = f.DateFrom?.ToString("yyyy-MM-dd"), to = f.DateTo?.ToString("yyyy-MM-dd"), status = f.Status, confirmation = f.ConfirmationState, search = f.Search })">Önceki</a>
            </li>

            <li class="page-item disabled"><span class="page-link">Sayfa @current / @totalPages</span></li>

            <li class="page-item @(current >= totalPages ? "disabled" : null)">
                <a class="page-link" href="@Url.Action("Index", new { page = current + 1, pageSize = Model.PageSize, from = f.DateFrom?.ToString("yyyy-MM-dd"), to = f.DateTo?.ToString("yyyy-MM-dd"), status = f.Status, confirmation = f.ConfirmationState, search = f.Search })">Sonraki</a>
            </li>
        </ul>
    </nav>
</div>

@section Scripts {
    <script>
        function confirmDecline(name) {
            return confirm(`${name} isimli danışanın randevu talebi reddedildi! Danışana red sebebi hakkında bilgi vermeyi lütfen unutmayınız!`);
        }
        // Eğer reddetme sonrası bilgi göstermek istenirse TempData üzerinden modal/alert:
        (function(){
            var info = '@(rejectInfo ?? string.Empty)';
            if (info) {
                alert(info + ' isimli danışanın randevu talebi reddedildi! Danışana red sebebi hakkında bilgi vermeyi lütfen unutmayınız!');
            }
        })();
    </script>
}
